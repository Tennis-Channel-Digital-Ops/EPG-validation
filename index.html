<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Channel EPG Dashboard</title>
    <link rel="icon" type="image/svg+xml" href="https://www.svgrepo.com/show/35457/calendar-symbol.svg">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .carousel-btn-prev::before { content: '\276E'; }
        .carousel-btn-next::before { content: '\276F'; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4 md:p-8">

<div class="max-w-7xl mx-auto bg-white rounded-lg shadow-xl p-6 md:p-8">

<header class="pb-6 border-b border-gray-200 mb-6">
    <div class="flex flex-col md:flex-row md:items-center md:justify-between">
        <div>
            <h1 id="main-title" class="text-3xl font-bold text-gray-900">EPG Dashboard</h1>
            <p id="channel-name" class="text-xl text-blue-600 font-medium mt-1"></p>
        </div>
        <div class="flex items-center space-x-4 mt-4 md:mt-0">
            <div id="watch-feed-container" class="relative">
                <button id="watch-feed-btn" class="hidden bg-blue-600 text-white px-4 py-2 rounded-md shadow-sm hover:bg-blue-700">
                    Watch Feed
                </button>
                <div id="video-player-dropdown" class="hidden absolute right-0 mt-2 w-96 bg-white border border-gray-200 rounded-lg shadow-lg z-50">
                    <div id="video-player" class="w-full h-full"></div>
                </div>
            </div>
            <div>
                <label for="timezone-select" class="block text-sm font-medium text-gray-700 mb-1">Timezone:</label>
                <select id="timezone-select" class="block w-full md:w-auto pl-3 pr-10 py-2 border-gray-300 rounded-md shadow-sm"></select>
            </div>
            <div>
                <label for="channel-select" class="block text-sm font-medium text-gray-700 mb-1">Select Channel:</label>
                <select id="channel-select" class="block w-full md:w-auto pl-3 pr-10 py-2 border-gray-300 rounded-md shadow-sm"></select>
            </div>
        </div>
    </div>
</header>

<div id="loading" class="flex flex-col items-center justify-center p-12">
    <div class="loader"></div>
    <p class="mt-4 text-lg font-medium text-gray-600">Fetching and analyzing EPG data...</p>
</div>

<div id="error" class="hidden p-6 bg-yellow-100 border border-yellow-300 rounded-lg">
    <h3 class="text-xl font-bold text-yellow-800">Initialization Required</h3>
    <div id="error-message" class="mt-2 text-yellow-900"></div>
</div>

<main id="content" class="hidden"></main>

</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const API_BASE_URL = 'https://192.168.8.126:1221/api';

    const loadingEl = document.getElementById('loading');
    const errorEl = document.getElementById('error');
    const errorMessageEl = document.getElementById('error-message');
    const contentEl = document.getElementById('content');
    const channelSelectEl = document.getElementById('channel-select');
    const timezoneSelectEl = document.getElementById('timezone-select');

    function showCertInstructions() {
        errorMessageEl.innerHTML = `
            <ol class="list-decimal ml-5 space-y-2">
                <li>
                    To initialize data click here:<br>
                    <a href="https://192.168.8.126:1221/api/channels" target="_blank" class="text-blue-700 underline">
                        https://192.168.8.126:1221/api/channels
                    </a>
                </li>
                <li>Then click <strong>Advanced</strong></li>
                <li>Finally click <strong>Proceed to 192.168.8.126 (unsafe)</strong></li>
                <li>Return to this page and refresh</li>
            </ol>
        `;
        loadingEl.classList.add('hidden');
        errorEl.classList.remove('hidden');
    }

    async function initialize() {
        try {
            const response = await fetch(`${API_BASE_URL}/channels`);
            if (!response.ok) throw new Error("Failed to fetch channels");

            const channels = await response.json();
            channels.forEach(ch => {
                const opt = document.createElement('option');
                opt.value = ch.id;
                opt.textContent = ch.name;
                channelSelectEl.appendChild(opt);
            });

            loadingEl.classList.add('hidden');
            contentEl.classList.remove('hidden');

        } catch (err) {
            console.error("Initialization failed:", err);
            showCertInstructions();
        }
    }

    initialize();
});
</script>

</body>
</html>
